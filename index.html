<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Avatar AR sin Marcadores</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <!-- A-Frame Extras para animaciones -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <!-- AR.js con soporte para location-based -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      
      #instructions {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 25px;
        border-radius: 12px;
        font-family: Arial, sans-serif;
        z-index: 1000;
        max-width: 320px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      }
      
      #instructions h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: #4CAF50;
      }
      
      #instructions p {
        margin: 10px 0;
        font-size: 14px;
        line-height: 1.5;
      }
      
      #startButton {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 15px;
        font-weight: bold;
      }
      
      #startButton:active {
        background: #45a049;
      }
      
      #controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: none;
        gap: 10px;
        z-index: 999;
      }
      
      .control-btn {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: 2px solid white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        font-weight: bold;
      }
      
      .control-btn:active {
        background: rgba(255, 255, 255, 0.3);
      }
      
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        z-index: 998;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="instructions">
      <h3>üì± AR sin Marcadores</h3>
      <p>El avatar aparecer√° frente a ti cuando inicies la c√°mara</p>
      <p><strong>Controles:</strong><br>
      üîÑ Toca para rotar<br>
      üìè Pellizca para escalar</p>
      <button id="startButton">Iniciar AR</button>
    </div>

    <div id="controls">
      <button class="control-btn" id="rotateBtn">üîÑ Rotar</button>
      <button class="control-btn" id="resetBtn">‚Ü∫ Reiniciar</button>
    </div>
    
    <div id="info">
      üëÜ Toca la pantalla para colocar el avatar
    </div>

    <!-- 
      Escena AR sin marcadores
      - embedded: integra AR en la p√°gina
      - arjs: sin detecci√≥n de marcadores
      - vr-mode-ui: desactiva bot√≥n VR
    -->
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true;"
      gesture-detector
      id="scene">
      
      <a-assets timeout="30000">
        <!-- Cambia esto por la URL de tu avatar en GitHub Pages -->
        <!-- Ejemplo: https://tu-usuario.github.io/tu-repo/avatar.glb -->
        <a-asset-item id="avatar" src="avatar.glb"></a-asset-item>
      </a-assets>

      <!-- 
        Avatar que aparecer√° frente a la c√°mara
        - position: frente a la c√°mara (0 altura, -3 distancia)
        - rotation: y=180 para mirar hacia la c√°mara
        - scale: tama√±o del avatar
      -->
      <a-entity id="avatar-container" 
                position="0 -0.5 -3" 
                visible="true"
                gesture-handler>
        <a-entity 
          id="avatar-model"
          position="0 0 0" 
          rotation="0 180 0"
          scale="0.5 0.5 0.5"
          gltf-model="#avatar"
          animation-mixer="clip: *; loop: repeat"
          shadow="cast: true; receive: false">
        </a-entity>
      </a-entity>

      <!-- Plano invisible para detectar toques -->
      <a-plane id="ground" 
               position="0 -1 -3" 
               rotation="-90 0 0" 
               width="10" 
               height="10" 
               color="#7BC8A4" 
               opacity="0"
               shadow="receive: true">
      </a-plane>

      <!-- Iluminaci√≥n -->
      <a-light type="ambient" color="#BBB"></a-light>
      <a-light type="directional" 
               position="2 4 -3" 
               intensity="0.5"
               castShadow="true">
      </a-light>

      <!-- C√°mara AR -->
      <a-camera id="camera" 
                position="0 1.6 0"
                look-controls="enabled: false">
      </a-camera>
    </a-scene>

    <script>
      // Variables globales
      let sceneReady = false;
      let avatarPlaced = false;

      // Componente para detectar gestos
      AFRAME.registerComponent('gesture-detector', {
        schema: {
          element: { default: '' }
        },
        init: function() {
          this.handleTouchStart = this.handleTouchStart.bind(this);
          this.handleTouchMove = this.handleTouchMove.bind(this);
          this.handleTouchEnd = this.handleTouchEnd.bind(this);
          
          this.touchStarted = false;
          this.touches = [];
        },
        play: function() {
          const canvas = this.el.sceneEl.canvas;
          canvas.addEventListener('touchstart', this.handleTouchStart);
          canvas.addEventListener('touchmove', this.handleTouchMove);
          canvas.addEventListener('touchend', this.handleTouchEnd);
        },
        pause: function() {
          const canvas = this.el.sceneEl.canvas;
          canvas.removeEventListener('touchstart', this.handleTouchStart);
          canvas.removeEventListener('touchmove', this.handleTouchMove);
          canvas.removeEventListener('touchend', this.handleTouchEnd);
        },
        handleTouchStart: function(event) {
          this.touchStarted = true;
          this.touches = Array.from(event.touches);
          
          // Un toque para rotar
          if (event.touches.length === 1) {
            this.el.emit('onefingermove', { 
              touch: event.touches[0],
              startTouch: this.touches[0]
            });
          }
          // Dos toques para escalar
          else if (event.touches.length === 2) {
            const dx = event.touches[0].pageX - event.touches[1].pageX;
            const dy = event.touches[0].pageY - event.touches[1].pageY;
            this.initialSpread = Math.sqrt(dx * dx + dy * dy);
          }
        },
        handleTouchMove: function(event) {
          if (!this.touchStarted) return;
          
          // Rotaci√≥n con un dedo
          if (event.touches.length === 1 && this.touches.length === 1) {
            const deltaX = event.touches[0].pageX - this.touches[0].pageX;
            const deltaY = event.touches[0].pageY - this.touches[0].pageY;
            
            this.el.emit('onefingermove', {
              positionChange: { x: deltaX, y: deltaY }
            });
            
            this.touches = Array.from(event.touches);
          }
          // Escala con dos dedos
          else if (event.touches.length === 2) {
            const dx = event.touches[0].pageX - event.touches[1].pageX;
            const dy = event.touches[0].pageY - event.touches[1].pageY;
            const spread = Math.sqrt(dx * dx + dy * dy);
            
            this.el.emit('twofingermove', {
              spreadChange: spread - this.initialSpread
            });
            
            this.initialSpread = spread;
          }
        },
        handleTouchEnd: function(event) {
          this.touchStarted = false;
          this.touches = [];
        }
      });

      // Componente para manejar gestos en el avatar
      AFRAME.registerComponent('gesture-handler', {
        schema: {
          enabled: { default: true },
          rotationFactor: { default: 2 },
          minScale: { default: 0.2 },
          maxScale: { default: 3 }
        },
        init: function() {
          this.handleRotation = this.handleRotation.bind(this);
          this.handleScale = this.handleScale.bind(this);
          
          this.initialScale = this.el.object3D.scale.clone();
          this.scaleFactor = 1;
        },
        play: function() {
          this.el.sceneEl.addEventListener('onefingermove', this.handleRotation);
          this.el.sceneEl.addEventListener('twofingermove', this.handleScale);
        },
        pause: function() {
          this.el.sceneEl.removeEventListener('onefingermove', this.handleRotation);
          this.el.sceneEl.removeEventListener('twofingermove', this.handleScale);
        },
        handleRotation: function(event) {
          if (!this.data.enabled) return;
          
          this.el.object3D.rotation.y += 
            event.detail.positionChange.x * this.data.rotationFactor * (Math.PI / 180);
        },
        handleScale: function(event) {
          if (!this.data.enabled) return;
          
          this.scaleFactor *= 1 + event.detail.spreadChange / 500;
          this.scaleFactor = Math.min(
            Math.max(this.scaleFactor, this.data.minScale), 
            this.data.maxScale
          );
          
          this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
          this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
          this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
        }
      });

      // Bot√≥n de inicio
      document.getElementById('startButton').addEventListener('click', async function() {
        try {
          // Solicitar permisos de c√°mara
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          });
          
          // Ocultar instrucciones
          document.getElementById('instructions').style.display = 'none';
          
          // Mostrar controles e info
          document.getElementById('controls').style.display = 'flex';
          document.getElementById('info').style.display = 'block';
          
          sceneReady = true;
          
          // Ocultar info despu√©s de 5 segundos
          setTimeout(() => {
            document.getElementById('info').style.opacity = '0';
            document.getElementById('info').style.transition = 'opacity 1s';
            setTimeout(() => {
              document.getElementById('info').style.display = 'none';
            }, 1000);
          }, 5000);
          
        } catch (error) {
          alert('Error al acceder a la c√°mara. Aseg√∫rate de dar permisos: ' + error.message);
        }
      });

      // Bot√≥n de rotaci√≥n
      document.getElementById('rotateBtn').addEventListener('click', function() {
        const avatar = document.getElementById('avatar-container');
        const currentRotation = avatar.getAttribute('rotation');
        avatar.setAttribute('rotation', {
          x: currentRotation.x,
          y: currentRotation.y + 45,
          z: currentRotation.z
        });
      });

      // Bot√≥n de reinicio
      document.getElementById('resetBtn').addEventListener('click', function() {
        const avatar = document.getElementById('avatar-container');
        avatar.setAttribute('position', '0 -0.5 -3');
        avatar.setAttribute('rotation', '0 180 0');
        avatar.setAttribute('scale', '0.5 0.5 0.5');
      });

      // Detectar cuando la escena est√° lista
      document.querySelector('a-scene').addEventListener('loaded', function() {
        console.log('Escena AR cargada');
      });
    </script>
  </body>
</html>