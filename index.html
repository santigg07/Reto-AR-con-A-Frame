<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar AR</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      #startButton {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #4CAF50;
        color: white;
        border: none;
        padding: 20px 40px;
        font-size: 20px;
        border-radius: 10px;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      #instructions {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 1000;
        text-align: center;
        display: none;
        max-width: 80%;
      }
      #debug {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.9);
        color: lime;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 10px;
        max-width: 90%;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1001;
      }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 30px;
        border-radius: 10px;
        z-index: 9998;
        display: none;
        text-align: center;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #resetBtn {
        position: fixed;
        top: 80px;
        right: 10px;
        background: rgba(255,100,100,0.9);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        display: none;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <button id="startButton">Iniciar AR</button>
    
    <div id="loading">
      <div class="spinner"></div>
      <div>Cargando cÃ¡mara...</div>
    </div>

    <div id="instructions">
      Toca la pantalla para colocar el avatar
    </div>

    <button id="resetBtn" onclick="resetAvatar()">Reintentar</button>

    <div id="debug"></div>

    <a-scene
      id="arScene"
      embedded
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true;"
      style="display: none;">
      
      <a-assets timeout="30000">
        <a-asset-item id="avatar" src="avatar.glb"></a-asset-item>
      </a-assets>

      <!-- IluminaciÃ³n intensa -->
      <a-entity light="type: ambient; intensity: 2"></a-entity>
      <a-entity light="type: directional; intensity: 1.5" position="2 5 2"></a-entity>
      <a-entity light="type: directional; intensity: 1.5" position="-2 5 -2"></a-entity>
      <a-entity light="type: point; intensity: 1" position="0 2 0"></a-entity>

      <!-- CÃ¡mara AR -->
      <a-camera id="arCamera" position="0 1.6 0"></a-camera>

      <!-- Contenedor del avatar -->
      <a-entity id="avatar-container"></a-entity>
    </a-scene>

    <script>
      const log = (msg, isError = false) => {
        const time = new Date().toLocaleTimeString();
        const debugEl = document.getElementById('debug');
        const color = isError ? 'red' : 'lime';
        debugEl.innerHTML += `<div style="color: ${color}">[${time}] ${msg}</div>`;
        debugEl.scrollTop = debugEl.scrollHeight;
        console.log(msg);
      };

      let avatarPlaced = false;
      let sceneEl;
      let videoStream = null;
      let avatarEntity = null;

      const startButton = document.getElementById('startButton');
      const loading = document.getElementById('loading');
      const instructions = document.getElementById('instructions');

      startButton.addEventListener('click', async () => {
        startButton.style.display = 'none';
        loading.style.display = 'block';

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });
          
          videoStream = stream;
          log('âœ“ CÃ¡mara activada');

          const video = document.createElement('video');
          video.setAttribute('autoplay', '');
          video.setAttribute('playsinline', '');
          video.style.position = 'fixed';
          video.style.top = '0';
          video.style.left = '0';
          video.style.width = '100%';
          video.style.height = '100%';
          video.style.objectFit = 'cover';
          video.style.zIndex = '-1';
          video.srcObject = stream;
          document.body.appendChild(video);

          sceneEl = document.getElementById('arScene');
          sceneEl.style.display = 'block';

          loading.style.display = 'none';
          instructions.style.display = 'block';

          log('âœ“ AR iniciado - esperando carga de assets');

          // Eventos de carga del modelo
          sceneEl.addEventListener('model-loaded', (evt) => {
            log('âœ“ Modelo GLB cargado exitosamente');
          });

          sceneEl.addEventListener('model-error', (evt) => {
            log('âœ— ERROR al cargar GLB: ' + JSON.stringify(evt.detail), true);
          });

          if (sceneEl.hasLoaded) {
            setupClickHandler();
          } else {
            sceneEl.addEventListener('loaded', setupClickHandler);
          }

        } catch (error) {
          log('âœ— Error al acceder a la cÃ¡mara: ' + error.message, true);
          loading.innerHTML = '<div style="color: #ff6b6b;">Error: No se pudo acceder a la cÃ¡mara<br><br>Verifica los permisos</div>';
          setTimeout(() => {
            loading.style.display = 'none';
            startButton.style.display = 'block';
          }, 3000);
        }
      });

      function setupClickHandler() {
        log('âœ“ Escena lista para interacciÃ³n');
        
        document.addEventListener('touchstart', placeAvatar);
        document.addEventListener('click', placeAvatar);
      }

      function placeAvatar(evt) {
        if (avatarPlaced) return;
        
        evt.preventDefault();
        avatarPlaced = true;

        log('Colocando avatar...');

        const container = document.getElementById('avatar-container');
        const camera = document.querySelector('#arCamera');
        
        // Obtener posiciÃ³n y rotaciÃ³n de la cÃ¡mara
        const cameraEl = camera.object3D;
        const cameraPos = cameraEl.position.clone();
        const cameraQuat = cameraEl.quaternion.clone();

        // Crear vector hacia adelante - MÃS LEJOS
        const forward = new THREE.Vector3(0, 0, -5); // 5 metros adelante
        forward.applyQuaternion(cameraQuat);
        
        const targetPos = cameraPos.clone().add(forward);
        targetPos.y = 0.5; // Elevar del suelo para mejor visibilidad

        log(`CÃ¡mara en: (${cameraPos.x.toFixed(2)}, ${cameraPos.y.toFixed(2)}, ${cameraPos.z.toFixed(2)})`);
        log(`Avatar en: (${targetPos.x.toFixed(2)}, ${targetPos.y.toFixed(2)}, ${targetPos.z.toFixed(2)})`);

        // Crear cubo de referencia MÃS GRANDE Y BRILLANTE
        const testCube = document.createElement('a-box');
        testCube.setAttribute('position', `${targetPos.x} ${targetPos.y + 2} ${targetPos.z}`);
        testCube.setAttribute('scale', '1 1 1'); // MUCHO MÃS GRANDE
        testCube.setAttribute('color', '#FF0000');
        testCube.setAttribute('material', 'shader: flat; emissive: #FF0000; emissiveIntensity: 1');
        testCube.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 2000');
        sceneEl.appendChild(testCube);
        
        // AÃ±adir esfera verde tambiÃ©n
        const sphere = document.createElement('a-sphere');
        sphere.setAttribute('position', `${targetPos.x} ${targetPos.y + 3} ${targetPos.z}`);
        sphere.setAttribute('radius', '0.5');
        sphere.setAttribute('color', '#00FF00');
        sphere.setAttribute('material', 'shader: flat; emissive: #00FF00; emissiveIntensity: 1');
        sphere.setAttribute('animation', 'property: position; to: ' + targetPos.x + ' ' + (targetPos.y + 3.5) + ' ' + targetPos.z + '; dir: alternate; loop: true; dur: 1000');
        sceneEl.appendChild(sphere);
        
        log('âœ“ Cubo rojo y esfera verde colocados como referencia');

        // Crear el avatar
        avatarEntity = document.createElement('a-entity');
        avatarEntity.setAttribute('gltf-model', '#avatar');
        avatarEntity.setAttribute('scale', '2 2 2'); // ESCALA GRANDE
        avatarEntity.setAttribute('position', `${targetPos.x} ${targetPos.y} ${targetPos.z}`);
        
        // Rotar hacia la cÃ¡mara
        avatarEntity.object3D.lookAt(cameraPos);
        avatarEntity.object3D.rotation.x = 0; // Mantener vertical

        // Agregar animaciÃ³n
        setTimeout(() => {
          if (avatarEntity.components['gltf-model']) {
            avatarEntity.setAttribute('animation-mixer', 'clip: *; loop: repeat');
            log('âœ“ Animaciones activadas');
          }
        }, 1000);

        container.appendChild(avatarEntity);
        log('âœ“ Avatar aÃ±adido a la escena');

        // Verificar si se cargÃ³
        avatarEntity.addEventListener('model-loaded', () => {
          log('âœ“âœ“ Avatar renderizado correctamente');
          instructions.innerHTML = 'Â¡Avatar colocado! ðŸŽ‰<br>DeberÃ­as ver un cubo rojo<br>El avatar estÃ¡ al lado';
          document.getElementById('resetBtn').style.display = 'block';
        });

        avatarEntity.addEventListener('model-error', (e) => {
          log('âœ—âœ— Error crÃ­tico al cargar avatar: ' + e.detail, true);
          instructions.innerHTML = 'Error al cargar avatar.glb<br>Â¿EstÃ¡ el archivo en la misma carpeta?';
        });

        instructions.innerHTML = 'Colocando avatar...<br>Busca un cubo rojo girando';
      }

      function resetAvatar() {
        log('--- REINICIANDO ---');
        avatarPlaced = false;
        
        const container = document.getElementById('avatar-container');
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        
        const cubes = document.querySelectorAll('a-box');
        cubes.forEach(c => c.remove());
        
        instructions.innerHTML = 'Toca la pantalla para colocar el avatar';
        instructions.style.display = 'block';
        document.getElementById('resetBtn').style.display = 'none';
      }

      window.addEventListener('beforeunload', () => {
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
        }
      });

      // Capturar todos los errores
      window.addEventListener('error', (e) => {
        log('âœ— Error JS: ' + e.message, true);
      });

      log('Script iniciado, presiona el botÃ³n');
    </script>
  </body>
</html>
