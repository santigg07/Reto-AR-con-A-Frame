<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Saludo Avatar VR/AR</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #debug-info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
        z-index: 1000;
        max-width: 300px;
        display: none;
      }
      #overlay {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        font-family: Arial, sans-serif;
        text-align: center;
        display: none;
        z-index: 999;
      }
    </style>
  </head>
  <body>
    <!-- Debug info -->
    <div id="debug-info"></div>

    <!-- Instrucciones AR -->
    <div id="overlay">
      <p style="margin: 0; font-size: 14px;">游녢 Apunta la c치mara al suelo y toca para colocar el avatar</p>
    </div>

    <!-- Escena con configuraci칩n simplificada para AR -->
    <a-scene 
      xr-mode-ui="enabled: true"
      renderer="colorManagement: true;"
      background="transparent"
      ar-mode>
      
      <a-assets timeout="30000">
        <a-asset-item id="avatarModel" src="avatar.glb"></a-asset-item>
      </a-assets>

      <!-- C치mara -->
      <a-camera position="0 1.6 0"></a-camera>

      <!-- Entorno VR -->
      <a-entity id="vr-environment" visible="true">
        <a-plane 
          position="0 0 0" 
          rotation="-90 0 0" 
          width="20" 
          height="20" 
          color="#7BC8A4"
          shadow="receive: true">
        </a-plane>
        <a-sky color="#ECECEC"></a-sky>
      </a-entity>

      <!-- Avatar -->
      <a-entity 
        id="avatar-container" 
        position="0 0 -3"
        visible="true">
        
        <a-entity 
          id="avatar-model"
          scale="1 1 1"
          position="0 0 0"
          gltf-model="#avatarModel"
          animation-mixer
          shadow="cast: true; receive: false">
        </a-entity>

        <a-text
          value="춰Hola! Soy tu Avatar"
          position="0 2 0"
          align="center"
          color="#FF6B6B"
          width="4"
          animation="property: position; to: 0 2.2 0; dir: alternate; dur: 1500; loop: true; easing: easeInOutSine">
        </a-text>
      </a-entity>

      <!-- Iluminaci칩n -->
      <a-entity light="type: ambient; intensity: 0.7;"></a-entity>
      <a-entity light="type: directional; intensity: 0.8;" position="1 2 1"></a-entity>
    </a-scene>

    <script>
      // Debug logging
      function log(msg) {
        console.log(msg);
        const debug = document.getElementById('debug-info');
        if (debug) {
          debug.style.display = 'block';
          debug.innerHTML += msg + '<br>';
        }
      }

      // Componente para manejar el modo AR
      AFRAME.registerComponent('ar-mode', {
        init: function() {
          const sceneEl = this.el;
          const avatar = document.getElementById('avatar-container');
          const vrEnv = document.getElementById('vr-environment');
          const overlay = document.getElementById('overlay');
          
          let isAR = false;
          let reticle = null;
          let hitTestSource = null;
          let hitTestSourceRequested = false;
          let localSpace = null;
          let isPlaced = false;

          log('AR component initialized');

          // Crear reticle (indicador de posici칩n)
          reticle = document.createElement('a-ring');
          reticle.setAttribute('position', '0 0 0');
          reticle.setAttribute('rotation', '-90 0 0');
          reticle.setAttribute('radius-inner', '0.15');
          reticle.setAttribute('radius-outer', '0.2');
          reticle.setAttribute('material', 'color: #fff; shader: flat; opacity: 0.8;');
          reticle.setAttribute('visible', 'false');
          sceneEl.appendChild(reticle);

          // Evento al entrar en XR (VR o AR)
          sceneEl.addEventListener('enter-vr', async () => {
            log('Entering XR...');
            
            const session = sceneEl.renderer.xr.getSession();
            
            if (!session) {
              log('No XR session found');
              return;
            }

            const mode = session.mode;
            log('XR mode: ' + mode);

            if (mode === 'immersive-ar') {
              isAR = true;
              log('AR mode activated');
              
              // Ocultar entorno VR
              if (vrEnv) vrEnv.setAttribute('visible', 'false');
              
              // Mostrar overlay
              if (overlay) overlay.style.display = 'block';
              
              // Ocultar avatar inicialmente hasta que se coloque
              if (avatar) avatar.setAttribute('visible', 'false');
              
              // Configurar hit test
              try {
                localSpace = await session.requestReferenceSpace('local');
                const viewerSpace = await session.requestReferenceSpace('viewer');
                hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
                hitTestSourceRequested = true;
                log('Hit test source created');
              } catch (err) {
                log('Error setting up hit test: ' + err.message);
              }
            } else {
              log('VR mode activated');
              isAR = false;
              if (vrEnv) vrEnv.setAttribute('visible', 'true');
              if (avatar) avatar.setAttribute('visible', 'true');
              if (overlay) overlay.style.display = 'none';
            }
          });

          // Evento al salir de XR
          sceneEl.addEventListener('exit-vr', () => {
            log('Exiting XR');
            isAR = false;
            isPlaced = false;
            hitTestSourceRequested = false;
            hitTestSource = null;
            
            if (reticle) reticle.setAttribute('visible', 'false');
            if (overlay) overlay.style.display = 'none';
            if (vrEnv) vrEnv.setAttribute('visible', 'true');
            if (avatar) {
              avatar.setAttribute('visible', 'true');
              avatar.setAttribute('position', '0 0 -3');
            }
          });

          // Click/touch para colocar el avatar
          sceneEl.addEventListener('click', () => {
            if (isAR && !isPlaced && reticle && reticle.getAttribute('visible')) {
              const pos = reticle.getAttribute('position');
              if (avatar) {
                avatar.setAttribute('position', pos);
                avatar.setAttribute('visible', 'true');
              }
              if (reticle) reticle.setAttribute('visible', 'false');
              if (overlay) overlay.style.display = 'none';
              isPlaced = true;
              log('Avatar placed at: ' + JSON.stringify(pos));
            }
          });

          // Frame loop para AR hit testing
          sceneEl.renderer.xr.addEventListener('sessionstart', () => {
            const session = sceneEl.renderer.xr.getSession();
            
            sceneEl.renderer.setAnimationLoop((timestamp, frame) => {
              if (!frame || !isAR || !hitTestSource || !localSpace) return;

              try {
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                
                if (hitTestResults.length > 0 && !isPlaced) {
                  const hit = hitTestResults[0];
                  const pose = hit.getPose(localSpace);
                  
                  if (pose && reticle) {
                    const pos = pose.transform.position;
                    reticle.setAttribute('position', {
                      x: pos.x,
                      y: pos.y,
                      z: pos.z
                    });
                    reticle.setAttribute('visible', 'true');
                  }
                }
              } catch (err) {
                // Silently handle errors in frame loop
              }
            });
          });
        }
      });

      // Verificar compatibilidad AR al cargar
      window.addEventListener('load', () => {
        if (navigator.xr) {
          navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            if (supported) {
              log('AR is supported on this device');
            } else {
              log('AR is NOT supported on this device');
              alert('Tu dispositivo no soporta WebXR AR. Aseg칰rate de usar Chrome y tener los Google Play Services actualizados.');
            }
          }).catch((err) => {
            log('Error checking AR support: ' + err.message);
          });
        } else {
          log('WebXR not available');
          alert('WebXR no est치 disponible. Aseg칰rate de usar Chrome en Android.');
        }
      });
    </script>
  </body>
</html>