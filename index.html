<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar AR</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      #startButton {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #4CAF50;
        color: white;
        border: none;
        padding: 20px 40px;
        font-size: 20px;
        border-radius: 10px;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      #startButton:active {
        background: #45a049;
      }
      #instructions {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 1000;
        text-align: center;
        display: none;
      }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 30px;
        border-radius: 10px;
        z-index: 9998;
        display: none;
        text-align: center;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <button id="startButton">Iniciar AR</button>
    
    <div id="loading">
      <div class="spinner"></div>
      <div>Cargando cÃ¡mara...</div>
    </div>

    <div id="instructions">
      Toca la pantalla para colocar el avatar
    </div>

    <a-scene
      id="arScene"
      embedded
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true;"
      style="display: none;">
      
      <a-assets timeout="30000">
        <a-asset-item id="avatar" src="avatar.glb"></a-asset-item>
      </a-assets>

      <!-- IluminaciÃ³n -->
      <a-entity light="type: ambient; intensity: 1.5"></a-entity>
      <a-entity light="type: directional; intensity: 1" position="2 4 2"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="-2 3 -1"></a-entity>
      <a-entity light="type: point; intensity: 0.5" position="0 2 0"></a-entity>

      <!-- CÃ¡mara AR -->
      <a-camera position="0 1.6 0"></a-camera>

      <!-- Contenedor del avatar -->
      <a-entity id="avatar-container"></a-entity>
    </a-scene>

    <script>
      let avatarPlaced = false;
      let sceneEl;
      let videoStream = null;

      const startButton = document.getElementById('startButton');
      const loading = document.getElementById('loading');
      const instructions = document.getElementById('instructions');

      startButton.addEventListener('click', async () => {
        startButton.style.display = 'none';
        loading.style.display = 'block';

        try {
          // Solicitar permisos de cÃ¡mara PRIMERO
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });
          
          videoStream = stream;
          console.log('âœ“ CÃ¡mara activada');

          // Crear elemento de video para el fondo
          const video = document.createElement('video');
          video.setAttribute('autoplay', '');
          video.setAttribute('playsinline', '');
          video.style.position = 'fixed';
          video.style.top = '0';
          video.style.left = '0';
          video.style.width = '100%';
          video.style.height = '100%';
          video.style.objectFit = 'cover';
          video.style.zIndex = '-1';
          video.srcObject = stream;
          document.body.appendChild(video);

          // Mostrar la escena A-Frame
          sceneEl = document.getElementById('arScene');
          sceneEl.style.display = 'block';

          loading.style.display = 'none';
          instructions.style.display = 'block';

          console.log('âœ“ AR iniciado');

          // Esperar a que la escena estÃ© lista
          if (sceneEl.hasLoaded) {
            setupClickHandler();
          } else {
            sceneEl.addEventListener('loaded', setupClickHandler);
          }

        } catch (error) {
          console.error('Error al acceder a la cÃ¡mara:', error);
          loading.innerHTML = '<div style="color: #ff6b6b;">Error: No se pudo acceder a la cÃ¡mara<br><br>Verifica los permisos</div>';
          setTimeout(() => {
            loading.style.display = 'none';
            startButton.style.display = 'block';
          }, 3000);
        }
      });

      function setupClickHandler() {
        console.log('âœ“ Escena cargada, listo para interacciÃ³n');
        
        document.addEventListener('touchstart', placeAvatar);
        document.addEventListener('click', placeAvatar);
      }

      function placeAvatar(evt) {
        if (avatarPlaced) return;
        
        evt.preventDefault();
        avatarPlaced = true;

        console.log('Colocando avatar...');

        const container = document.getElementById('avatar-container');
        const camera = document.querySelector('a-camera');
        const cameraPos = camera.object3D.position;
        const cameraRot = camera.object3D.rotation;

        // Crear el avatar
        const avatar = document.createElement('a-entity');
        avatar.setAttribute('gltf-model', '#avatar');
        avatar.setAttribute('scale', '1 1 1');
        avatar.setAttribute('animation-mixer', 'clip: *; loop: repeat');

        // Calcular posiciÃ³n frente a la cÃ¡mara
        const distance = 2;
        const x = cameraPos.x - Math.sin(cameraRot.y) * distance;
        const y = 0;
        const z = cameraPos.z - Math.cos(cameraRot.y) * distance;

        avatar.setAttribute('position', `${x} ${y} ${z}`);
        avatar.setAttribute('rotation', `0 ${cameraRot.y * (180/Math.PI) + 180} 0`);

        // AÃ±adir marcador visual
        const marker = document.createElement('a-sphere');
        marker.setAttribute('position', `${x} ${y + 1.5} ${z}`);
        marker.setAttribute('radius', '0.1');
        marker.setAttribute('color', '#FF0000');
        marker.setAttribute('animation', 'property: position; to: ' + x + ' ' + (y + 1.8) + ' ' + z + '; dir: alternate; loop: true; dur: 1000');

        sceneEl.appendChild(marker);
        container.appendChild(avatar);

        instructions.innerHTML = 'Â¡Avatar colocado! ðŸŽ‰<br>Mueve el mÃ³vil para verlo mejor';
        
        setTimeout(() => {
          instructions.style.opacity = '0.7';
        }, 3000);

        console.log(`Avatar en posiciÃ³n: (${x.toFixed(2)}, ${y}, ${z.toFixed(2)})`);
      }

      // Limpieza al salir
      window.addEventListener('beforeunload', () => {
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
        }
      });
    </script>
  </body>
</html>