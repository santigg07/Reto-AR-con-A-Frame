<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar AR</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #instructions {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-family: Arial, sans-serif;
        z-index: 1000;
        text-align: center;
        max-width: 80%;
      }
      #debug {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.9);
        color: lime;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 11px;
        max-width: 90%;
        max-height: 150px;
        overflow-y: auto;
        z-index: 1000;
      }
      .hidden {
        display: none;
      }
      #resetBtn {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: rgba(255,0,0,0.8);
        color: white;
        border: none;
        padding: 15px 20px;
        border-radius: 10px;
        font-size: 16px;
        z-index: 1000;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="instructions">
      Toca la pantalla para colocar el avatar
    </div>
    
    <div id="debug"></div>
    
    <button id="resetBtn" onclick="resetAvatar()">Reiniciar</button>

    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true;"
      background="color: #87CEEB">
      
      <!-- Assets -->
      <a-assets timeout="30000">
        <a-asset-item id="avatar" src="avatar.glb"></a-asset-item>
      </a-assets>

      <!-- Luces mejoradas -->
      <a-entity light="type: ambient; intensity: 1.2; color: #FFF"></a-entity>
      <a-entity light="type: directional; intensity: 1; color: #FFF" position="2 4 2"></a-entity>
      <a-entity light="type: directional; intensity: 0.5; color: #FFF" position="-2 4 -2"></a-entity>

      <!-- CÃ¡mara -->
      <a-camera position="0 1.6 0" look-controls="enabled: true" wasd-controls="enabled: false"></a-camera>

      <!-- Suelo de referencia (opcional, para debugging) -->
      <a-plane id="ground" position="0 0 0" rotation="-90 0 0" width="20" height="20" 
               color="#7BC8A4" opacity="0.3" visible="false"></a-plane>

      <!-- Contenedor del avatar -->
      <a-entity id="avatar-container"></a-entity>
    </a-scene>

    <script>
      const debugLog = (msg) => {
        const debugEl = document.getElementById('debug');
        const time = new Date().toLocaleTimeString();
        debugEl.innerHTML += `<div>[${time}] ${msg}</div>`;
        debugEl.scrollTop = debugEl.scrollHeight;
        console.log(msg);
      };

      let sceneReady = false;
      let avatarPlaced = false;
      let avatarEntity = null;

      const sceneEl = document.querySelector('a-scene');
      
      sceneEl.addEventListener('loaded', () => {
        debugLog('âœ“ Escena A-Frame cargada');
        sceneReady = true;
      });

      sceneEl.addEventListener('model-loaded', (evt) => {
        debugLog('âœ“ Modelo GLB cargado exitosamente');
        if (avatarEntity) {
          // Hacer visible el suelo para referencia
          document.getElementById('ground').setAttribute('visible', 'true');
        }
      });

      sceneEl.addEventListener('model-error', (evt) => {
        debugLog('âœ— ERROR al cargar modelo: ' + evt.detail);
        document.getElementById('instructions').innerHTML = 
          'Error: No se pudo cargar avatar.glb<br>Verifica la ruta del archivo';
      });

      // Colocar avatar al tocar
      document.addEventListener('touchstart', handlePlacement);
      document.addEventListener('click', handlePlacement);

      function handlePlacement(evt) {
        if (!sceneReady || avatarPlaced) return;
        evt.preventDefault();
        placeAvatar();
      }

      function placeAvatar() {
        avatarPlaced = true;
        debugLog('Colocando avatar...');

        const container = document.getElementById('avatar-container');
        const camera = document.querySelector('a-camera');
        const cameraPos = camera.getAttribute('position');
        const cameraRot = camera.getAttribute('rotation');

        // Crear el avatar
        avatarEntity = document.createElement('a-entity');
        avatarEntity.setAttribute('gltf-model', '#avatar');
        
        // Escala mÃ¡s grande para asegurar visibilidad
        avatarEntity.setAttribute('scale', '1.5 1.5 1.5');
        
        // Activar animaciones
        avatarEntity.setAttribute('animation-mixer', 'clip: *; loop: repeat; timeScale: 1');
        
        // PosiciÃ³n: directamente frente a la cÃ¡mara
        const distance = 3; // 3 metros frente
        const angle = (cameraRot.y || 0) * (Math.PI / 180);
        
        const x = cameraPos.x - Math.sin(angle) * distance;
        const y = 0.5; // Elevar un poco del suelo
        const z = cameraPos.z - Math.cos(angle) * distance;
        
        avatarEntity.setAttribute('position', `${x} ${y} ${z}`);
        
        // Rotar hacia la cÃ¡mara
        avatarEntity.setAttribute('rotation', `0 ${(cameraRot.y || 0) + 180} 0`);

        // AÃ±adir marcador visual de referencia (cubo rojo)
        const marker = document.createElement('a-box');
        marker.setAttribute('position', `${x} ${y + 2} ${z}`);
        marker.setAttribute('scale', '0.2 0.2 0.2');
        marker.setAttribute('color', 'red');
        marker.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 2000');
        sceneEl.appendChild(marker);

        container.appendChild(avatarEntity);

        debugLog(`Avatar colocado en (${x.toFixed(2)}, ${y.toFixed(2)}, ${z.toFixed(2)})`);
        debugLog(`CÃ¡mara en (${cameraPos.x}, ${cameraPos.y}, ${cameraPos.z})`);
        debugLog(`RotaciÃ³n cÃ¡mara: ${cameraRot.y}Â°`);

        document.getElementById('instructions').innerHTML = 
          'Â¡Avatar colocado! ðŸŽ‰<br>Mira arriba, verÃ¡s un cubo rojo de referencia<br>El avatar estÃ¡ debajo';
        
        document.getElementById('resetBtn').style.display = 'block';
        
        // Auto-ocultar instrucciones
        setTimeout(() => {
          document.getElementById('instructions').style.opacity = '0.7';
          document.getElementById('instructions').style.fontSize = '12px';
        }, 5000);
      }

      function resetAvatar() {
        debugLog('Reiniciando...');
        avatarPlaced = false;
        const container = document.getElementById('avatar-container');
        container.innerHTML = '';
        
        // Limpiar marcadores
        const markers = document.querySelectorAll('a-box[color="red"]');
        markers.forEach(m => m.remove());
        
        document.getElementById('instructions').innerHTML = 
          'Toca la pantalla para colocar el avatar';
        document.getElementById('instructions').style.opacity = '1';
        document.getElementById('instructions').style.fontSize = '14px';
        document.getElementById('resetBtn').style.display = 'none';
        document.getElementById('ground').setAttribute('visible', 'false');
      }

      // Detectar errores generales
      window.addEventListener('error', (e) => {
        debugLog('âœ— ERROR JS: ' + e.message);
      });

      debugLog('Script cargado, esperando interacciÃ³n...');
    </script>
  </body>
</html>