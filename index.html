<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar AR - Final</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      
      #videoContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        background: #000;
      }
      
      #videoContainer video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      #scene {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1 !important;
      }
      
      #scene canvas {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
      }
      
      #startBtn {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 25px 50px;
        font-size: 22px;
        border-radius: 15px;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        font-weight: bold;
      }
      
      #startBtn:active {
        transform: translate(-50%, -50%) scale(0.95);
      }
      
      #instructions {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        z-index: 9999;
        text-align: center;
        display: none;
        font-size: 16px;
        max-width: 80%;
      }
      
      #placeBtn {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        padding: 20px 40px;
        font-size: 20px;
        border-radius: 50px;
        cursor: pointer;
        z-index: 9999;
        display: none;
        box-shadow: 0 8px 25px rgba(245,87,108,0.4);
        font-weight: bold;
      }
      
      #placeBtn:active {
        transform: translateX(-50%) scale(0.95);
      }
      
      .placed {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
      }
    </style>
  </head>
  <body>
    <button id="startBtn">üöÄ INICIAR AR</button>
    <div id="instructions">Preparando AR...</div>
    <button id="placeBtn">üìç COLOCAR AVATAR</button>

    <div id="videoContainer"></div>

    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="colorManagement: true; antialias: true; alpha: false; logarithmicDepthBuffer: true"
      background="color: #87CEEB"
      style="display: none;">
      
      <a-assets>
        <a-asset-item id="avatarModel" src="avatar.glb"></a-asset-item>
      </a-assets>

      <!-- Iluminaci√≥n √≥ptima -->
      <a-entity light="type: ambient; intensity: 2"></a-entity>
      <a-entity light="type: directional; intensity: 1.5" position="5 5 5"></a-entity>
      <a-entity light="type: directional; intensity: 1" position="-5 3 -3"></a-entity>
      <a-entity light="type: point; intensity: 1; color: #FFF" position="0 3 0"></a-entity>

      <!-- C√°mara con cursor visible -->
      <a-camera id="cam" position="0 1.6 0" look-controls="enabled: true" wasd-controls="enabled: false">
        <a-ring position="0 0 -0.5" radius-inner="0.01" radius-outer="0.02" color="#FF0000" opacity="0.8"></a-ring>
      </a-camera>
      
      <a-entity id="container"></a-entity>
      
      <!-- Plano suelo semi-transparente -->
      <a-plane position="0 0 0" rotation="-90 0 0" width="30" height="30" 
               color="#4CAF50" opacity="0.2" visible="false" id="ground"></a-plane>
    </a-scene>

    <script>
      let videoStream = null;
      let sceneEl = null;
      let avatarPlaced = false;

      // Iniciar AR
      document.getElementById('startBtn').onclick = async function() {
        this.style.display = 'none';
        const instructions = document.getElementById('instructions');
        instructions.style.display = 'block';
        instructions.textContent = 'Activando c√°mara...';

        try {
          // Obtener c√°mara
          videoStream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });

          // Mostrar video
          const videoContainer = document.getElementById('videoContainer');
          const video = document.createElement('video');
          video.autoplay = true;
          video.playsInline = true;
          video.muted = true;
          video.srcObject = videoStream;
          videoContainer.appendChild(video);

          // Activar escena A-Frame
          sceneEl = document.getElementById('scene');
          sceneEl.style.display = 'block';
          
          // Hacer fondo transparente para ver el video
          sceneEl.setAttribute('background', 'transparent: true; alpha: true');
          
          // Configurar canvas transparente
          setTimeout(() => {
            const canvas = sceneEl.canvas;
            if (canvas) {
              canvas.style.background = 'transparent';
            }
          }, 500);

          instructions.textContent = '‚úì AR Activo';
          setTimeout(() => {
            instructions.textContent = 'Apunta donde quieres colocar el avatar';
          }, 1500);

          document.getElementById('placeBtn').style.display = 'block';

        } catch (err) {
          instructions.textContent = '‚ùå Error: ' + err.message;
          instructions.style.background = 'rgba(200,0,0,0.9)';
        }
      };

      // Colocar avatar
      document.getElementById('placeBtn').onclick = function() {
        if (avatarPlaced) {
          // Reset
          document.getElementById('container').innerHTML = '';
          document.getElementById('ground').setAttribute('visible', 'false');
          avatarPlaced = false;
          this.textContent = 'üìç COLOCAR AVATAR';
          this.classList.remove('placed');
          document.getElementById('instructions').textContent = 'Apunta donde quieres colocar el avatar';
          return;
        }

        avatarPlaced = true;
        this.textContent = 'üîÑ REINICIAR';
        this.classList.add('placed');

        const container = document.getElementById('container');
        const cam = document.getElementById('cam');
        
        // Obtener direcci√≥n de la c√°mara
        const direction = new THREE.Vector3();
        cam.object3D.getWorldDirection(direction);
        
        const cameraPos = cam.object3D.position.clone();
        
        // Colocar a 2 metros en la direcci√≥n que mira
        const distance = 2;
        const targetPos = cameraPos.clone().add(direction.multiplyScalar(-distance));
        targetPos.y = 0; // En el suelo

        // Avatar principal
        const avatar = document.createElement('a-entity');
        avatar.setAttribute('gltf-model', '#avatarModel');
        avatar.setAttribute('position', `${targetPos.x} ${targetPos.y} ${targetPos.z}`);
        avatar.setAttribute('scale', '1 1 1');
        
        // Rotar hacia la c√°mara
        avatar.object3D.lookAt(cameraPos);
        avatar.object3D.rotation.x = 0;
        
        avatar.addEventListener('model-loaded', () => {
          avatar.setAttribute('animation-mixer', 'clip: *; loop: repeat');
          document.getElementById('instructions').innerHTML = '‚úì ¬°Avatar colocado!<br>Mu√©vete para verlo desde diferentes √°ngulos';
          
          // Auto-ocultar despu√©s de 3 segundos
          setTimeout(() => {
            document.getElementById('instructions').style.opacity = '0.6';
          }, 3000);
        });

        container.appendChild(avatar);

        // Marcador de suelo (opcional)
        document.getElementById('ground').setAttribute('visible', 'true');
        document.getElementById('ground').setAttribute('position', `${targetPos.x} -0.01 ${targetPos.z}`);

        console.log(`Avatar colocado en: (${targetPos.x.toFixed(2)}, ${targetPos.y.toFixed(2)}, ${targetPos.z.toFixed(2)})`);
      };

      // Limpieza
      window.addEventListener('beforeunload', () => {
        if (videoStream) {
          videoStream.getTracks().forEach(t => t.stop());
        }
      });
    </script>
  </body>
</html>