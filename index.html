<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar AR - Test Render</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: monospace;
      }
      #status {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.9);
        color: lime;
        padding: 10px;
        font-size: 11px;
        max-height: 30vh;
        overflow-y: auto;
        z-index: 10000;
      }
      #controls {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.9);
        padding: 15px;
        z-index: 10000;
        text-align: center;
      }
      button {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 15px 30px;
        margin: 5px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
      }
      button:active { background: #45a049; }
      .red { background: #f44336 !important; }
      
      /* CRÍTICO: Asegurar que el canvas esté visible */
      #scene {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1 !important;
      }
      
      #scene canvas {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
      }
      
      #videoContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        background: #000;
      }
      
      #videoContainer video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    <div id="status">Iniciando...</div>

    <div id="controls">
      <button onclick="testMode()">TEST SIN CÁMARA</button>
      <button onclick="startWithCamera()" class="red">AR CON CÁMARA</button>
    </div>

    <div id="videoContainer"></div>

    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="colorManagement: true; antialias: true; alpha: false; logarithmicDepthBuffer: true"
      background="color: #222">
      
      <a-assets>
        <a-asset-item id="avatarModel" src="avatar.glb"></a-asset-item>
      </a-assets>

      <a-entity light="type: ambient; intensity: 1.5"></a-entity>
      <a-entity light="type: directional; intensity: 1" position="5 5 5"></a-entity>
      <a-entity light="type: point; intensity: 0.8; color: #FFF" position="0 3 -3"></a-entity>

      <a-camera id="cam" position="0 1.6 3" look-controls="enabled: true" wasd-controls="enabled: false">
        <a-cursor color="#FF0000" opacity="0.8"></a-cursor>
      </a-camera>
      
      <a-entity id="container"></a-entity>
      
      <!-- Suelo para referencia -->
      <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20" color="#555" opacity="0.8"></a-plane>
    </a-scene>

    <script>
      const log = (msg, color = 'lime') => {
        const s = document.getElementById('status');
        const time = new Date().toLocaleTimeString();
        s.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
        s.scrollTop = s.scrollHeight;
        console.log(msg);
      };

      let scene = null;
      let objectsPlaced = false;

      // MODO TEST: Sin cámara, solo para ver si A-Frame renderiza
      window.testMode = function() {
        log('=== MODO TEST (SIN CÁMARA) ===', 'cyan');
        log('Esto te permitirá ver si A-Frame funciona en tu dispositivo', 'yellow');
        
        scene = document.getElementById('scene');
        
        // Asegurar que el canvas sea visible
        setTimeout(() => {
          const canvas = scene.canvas;
          if (canvas) {
            log('✓ Canvas encontrado: ' + canvas.width + 'x' + canvas.height, 'lime');
            canvas.style.display = 'block';
            canvas.style.visibility = 'visible';
            canvas.style.zIndex = '1';
          } else {
            log('✗ Canvas NO encontrado', 'red');
          }
        }, 1000);

        if (scene.hasLoaded) {
          placeTestObjects();
        } else {
          scene.addEventListener('loaded', placeTestObjects);
        }
      };

      // MODO AR: Con cámara
      window.startWithCamera = async function() {
        log('=== MODO AR (CON CÁMARA) ===', 'cyan');
        
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
          });
          
          log('✓ Cámara obtenida', 'lime');

          // Video de fondo
          const videoContainer = document.getElementById('videoContainer');
          const video = document.createElement('video');
          video.autoplay = true;
          video.playsInline = true;
          video.muted = true;
          video.srcObject = stream;
          videoContainer.appendChild(video);

          log('✓ Video activado', 'lime');

          scene = document.getElementById('scene');
          
          // Hacer el fondo de A-Frame transparente para ver el video
          scene.setAttribute('background', 'transparent: true; alpha: true');
          
          // Forzar el canvas visible encima del video
          setTimeout(() => {
            const canvas = scene.canvas;
            if (canvas) {
              canvas.style.background = 'transparent';
              log('✓ Canvas configurado transparente sobre video', 'lime');
            }
          }, 1000);

          if (scene.hasLoaded) {
            placeTestObjects();
          } else {
            scene.addEventListener('loaded', placeTestObjects);
          }

        } catch (err) {
          log('✗ ERROR cámara: ' + err.message, 'red');
        }
      };

      function placeTestObjects() {
        if (objectsPlaced) return;
        objectsPlaced = true;

        log('Colocando objetos de prueba...', 'cyan');

        const container = document.getElementById('container');

        // Objetos SIMPLES y GRANDES justo frente a la cámara
        const testObjects = [
          // Cubo rojo MUY CERCA
          { type: 'box', pos: '0 1.6 -1', scale: '0.5 0.5 0.5', color: '#FF0000', label: 'ROJO-CERCA' },
          // Esfera verde a medio camino
          { type: 'sphere', pos: '0 1.6 -3', scale: '0.7 0.7 0.7', color: '#00FF00', label: 'VERDE-MEDIO' },
          // Cilindro azul lejos
          { type: 'cylinder', pos: '0 1.6 -5', scale: '0.5 1 0.5', color: '#0000FF', label: 'AZUL-LEJOS' },
          // Cubo amarillo a la derecha
          { type: 'box', pos: '2 1.6 -3', scale: '0.5 0.5 0.5', color: '#FFFF00', label: 'AMARILLO-DER' },
          // Cubo magenta a la izquierda
          { type: 'box', pos: '-2 1.6 -3', scale: '0.5 0.5 0.5', color: '#FF00FF', label: 'MAGENTA-IZQ' },
        ];

        testObjects.forEach(obj => {
          const el = document.createElement(`a-${obj.type}`);
          el.setAttribute('position', obj.pos);
          el.setAttribute('scale', obj.scale);
          el.setAttribute('color', obj.color);
          el.setAttribute('material', `emissive: ${obj.color}; emissiveIntensity: 0.5; metalness: 0.1`);
          
          // Animación de rotación
          el.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear');
          
          container.appendChild(el);
          log(`✓ ${obj.label} en ${obj.pos}`, obj.color);
        });

        // Avatar
        const avatar = document.createElement('a-entity');
        avatar.setAttribute('gltf-model', '#avatarModel');
        avatar.setAttribute('position', '0 0 -4');
        avatar.setAttribute('scale', '1 1 1');
        
        avatar.addEventListener('model-loaded', () => {
          log('✓✓ AVATAR CARGADO', 'lime');
          avatar.setAttribute('animation-mixer', 'clip: *');
        });
        
        container.appendChild(avatar);

        log('=== 5 OBJETOS + AVATAR COLOCADOS ===', 'cyan');
        log('Deberías ver objetos rotando frente a ti', 'yellow');
        log('Si NO ves nada, el problema es el renderer de A-Frame', 'yellow');
      }

      // Info de A-Frame
      setTimeout(() => {
        if (typeof AFRAME !== 'undefined') {
          log('✓ A-Frame v' + AFRAME.version, 'lime');
          log('WebGL: ' + (!!window.WebGLRenderingContext ? 'Soportado' : 'NO soportado'), 'yellow');
        }
      }, 500);

      log('Elige un modo:', 'cyan');
      log('TEST SIN CÁMARA - Para ver si A-Frame funciona', 'white');
      log('AR CON CÁMARA - Para AR real', 'white');
    </script>
  </body>
</html>