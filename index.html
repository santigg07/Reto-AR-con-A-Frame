<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar AR - Debug</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: monospace;
      }
      #ui {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10000;
        pointer-events: none;
      }
      #status {
        background: rgba(0,0,0,0.9);
        color: lime;
        padding: 10px;
        font-size: 12px;
        max-height: 40vh;
        overflow-y: auto;
      }
      #controls {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.9);
        padding: 15px;
        z-index: 10000;
        text-align: center;
      }
      button {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 15px 30px;
        margin: 5px;
        border-radius: 10px;
        font-size: 16px;
        pointer-events: all;
        cursor: pointer;
      }
      button:active {
        background: #45a049;
      }
      .red { background: #f44336 !important; }
      .blue { background: #2196F3 !important; }
    </style>
  </head>
  <body>
    <div id="ui">
      <div id="status">Iniciando...</div>
    </div>

    <div id="controls">
      <button id="startBtn" onclick="startAR()">1. INICIAR C√ÅMARA</button>
      <button id="placeBtn" onclick="placeObjects()" style="display:none;" class="red">2. COLOCAR OBJETOS</button>
      <button onclick="showInfo()" style="display:none;" class="blue" id="infoBtn">üìä INFO C√ÅMARA</button>
    </div>

    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled: false"
      renderer="colorManagement: true; antialias: true;"
      background="color: #87CEEB; transparent: true"
      style="display: none;">
      
      <a-assets>
        <a-asset-item id="avatarModel" src="avatar.glb"></a-asset-item>
      </a-assets>

      <a-entity light="type: ambient; intensity: 3"></a-entity>
      <a-entity light="type: directional; intensity: 2" position="10 10 10"></a-entity>
      <a-entity light="type: point; intensity: 1" position="0 2 0"></a-entity>

      <a-camera id="cam" position="0 0 0" wasd-controls="enabled: false"></a-camera>
      
      <a-entity id="container"></a-entity>
    </a-scene>

    <script>
      const log = (msg, color = 'lime') => {
        const s = document.getElementById('status');
        const time = new Date().toLocaleTimeString();
        s.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
        s.scrollTop = s.scrollHeight;
        console.log(msg);
      };

      let videoStream = null;
      let sceneEl = null;
      let objectsPlaced = false;

      window.startAR = async function() {
        log('Solicitando c√°mara...');
        
        try {
          videoStream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });
          
          log('‚úì C√°mara obtenida', 'lime');

          // Video de fondo
          const video = document.createElement('video');
          video.autoplay = true;
          video.playsInline = true;
          video.muted = true;
          video.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
          `;
          video.srcObject = videoStream;
          
          video.onloadedmetadata = () => {
            log(`‚úì Video: ${video.videoWidth}x${video.videoHeight}`, 'lime');
          };
          
          document.body.appendChild(video);

          // Mostrar escena A-Frame
          sceneEl = document.getElementById('scene');
          sceneEl.style.display = 'block';

          log('‚úì Escena A-Frame activada', 'lime');

          // Esperar a que cargue
          if (sceneEl.hasLoaded) {
            onSceneLoaded();
          } else {
            sceneEl.addEventListener('loaded', onSceneLoaded);
          }

          document.getElementById('startBtn').style.display = 'none';
          document.getElementById('placeBtn').style.display = 'inline-block';
          document.getElementById('infoBtn').style.display = 'inline-block';

        } catch (err) {
          log('‚úó ERROR: ' + err.message, 'red');
          log('Verifica permisos de c√°mara', 'yellow');
        }
      };

      function onSceneLoaded() {
        log('‚úì A-Frame completamente cargado', 'lime');
        log('Toca "2. COLOCAR OBJETOS"', 'cyan');
      }

      window.placeObjects = function() {
        if (objectsPlaced) {
          log('Ya hay objetos. Recargando...', 'yellow');
          document.getElementById('container').innerHTML = '';
          objectsPlaced = false;
          setTimeout(() => placeObjects(), 500);
          return;
        }

        objectsPlaced = true;
        log('--- COLOCANDO OBJETOS ---', 'cyan');

        const container = document.getElementById('container');
        const cam = document.getElementById('cam');

        // Obtener posici√≥n real de la c√°mara
        const camPos = cam.object3D.position;
        log(`C√°mara en: (${camPos.x.toFixed(2)}, ${camPos.y.toFixed(2)}, ${camPos.z.toFixed(2)})`, 'yellow');

        // ESTRATEGIA 1: Objetos en posiciones ABSOLUTAS simples
        // Esto elimina cualquier problema de c√°lculo de direcci√≥n
        
        const positions = [
          { x: 0, y: 1, z: -2, color: '#FF0000', label: 'FRENTE' },
          { x: 2, y: 1, z: 0, color: '#00FF00', label: 'DERECHA' },
          { x: 0, y: 1, z: 2, color: '#0000FF', label: 'DETR√ÅS' },
          { x: -2, y: 1, z: 0, color: '#FFFF00', label: 'IZQUIERDA' },
          { x: 0, y: 2, z: -2, color: '#FF00FF', label: 'ARRIBA' },
        ];

        positions.forEach((pos, idx) => {
          // Esfera grande
          const sphere = document.createElement('a-sphere');
          sphere.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
          sphere.setAttribute('radius', '0.3');
          sphere.setAttribute('color', pos.color);
          sphere.setAttribute('material', `emissive: ${pos.color}; emissiveIntensity: 2; side: double`);
          sphere.setAttribute('segments-width', '16');
          sphere.setAttribute('segments-height', '16');
          container.appendChild(sphere);

          // Texto
          const text = document.createElement('a-text');
          text.setAttribute('value', pos.label);
          text.setAttribute('position', `${pos.x} ${pos.y + 0.5} ${pos.z}`);
          text.setAttribute('align', 'center');
          text.setAttribute('color', '#FFFFFF');
          text.setAttribute('scale', '1.5 1.5 1.5');
          text.setAttribute('side', 'double');
          container.appendChild(text);

          log(`‚úì ${pos.label}: (${pos.x}, ${pos.y}, ${pos.z})`, pos.color);
        });

        // Avatar justo FRENTE
        const avatar = document.createElement('a-entity');
        avatar.setAttribute('gltf-model', '#avatarModel');
        avatar.setAttribute('position', '0 0 -2.5');
        avatar.setAttribute('scale', '1 1 1');
        avatar.setAttribute('rotation', '0 0 0');
        
        avatar.addEventListener('model-loaded', () => {
          log('‚úì AVATAR CARGADO Y VISIBLE', 'lime');
          avatar.setAttribute('animation-mixer', 'clip: *');
        });

        avatar.addEventListener('model-error', (e) => {
          log('‚úó Error en avatar: ' + JSON.stringify(e.detail), 'red');
        });

        container.appendChild(avatar);
        log('‚úì Avatar a√±adido en (0, 0, -2.5)', 'lime');

        log('--- TOTAL: 5 esferas + 5 textos + 1 avatar ---', 'cyan');
        log('INSTRUCCI√ìN: Gira LENTAMENTE 360¬∞', 'yellow');
        log('Deber√≠as ver: FRENTE(rojo), DERECHA(verde), DETR√ÅS(azul), IZQUIERDA(amarillo)', 'yellow');
      };

      window.showInfo = function() {
        const cam = document.getElementById('cam');
        const pos = cam.object3D.position;
        const rot = cam.object3D.rotation;
        
        log('=== INFO C√ÅMARA ===', 'cyan');
        log(`Posici√≥n: (${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)})`, 'white');
        log(`Rotaci√≥n: (${(rot.x*180/Math.PI).toFixed(0)}¬∞, ${(rot.y*180/Math.PI).toFixed(0)}¬∞, ${(rot.z*180/Math.PI).toFixed(0)}¬∞)`, 'white');
        
        const container = document.getElementById('container');
        log(`Objetos en escena: ${container.children.length}`, 'white');

        // Info del navegador
        log(`Navegador: ${navigator.userAgent.substring(0, 50)}...`, 'white');
        log(`Pantalla: ${window.innerWidth}x${window.innerHeight}`, 'white');
      };

      // Logs de A-Frame
      if (typeof AFRAME !== 'undefined') {
        log('‚úì A-Frame cargado v' + AFRAME.version, 'lime');
      }

      window.addEventListener('error', (e) => {
        log('‚úó ERROR JS: ' + e.message, 'red');
      });

      log('Script listo. Toca "1. INICIAR C√ÅMARA"', 'cyan');
    </script>
  </body>
</html>